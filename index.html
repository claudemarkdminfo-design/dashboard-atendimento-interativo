<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>IXC — Dashboard de Quedas • v2.2</title>
  
  <!-- Fontes e Bibliotecas -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>try{pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";}catch(e){}</script>

  <style>
    :root {
      --bg: #f3f4f6;
      --sidebar: #ffffff;
      --surface: #ffffff;
      --text: #1f2937;
      --text-sec: #6b7280;
      --border: #e5e7eb;
      --brand: #3b82f6;
      --brand-hover: #2563eb;
      --brand-soft: #eff6ff;
      --good: #10b981;
      --warn: #f59e0b;
      --bad: #ef4444;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --font-main: 'Inter', sans-serif;
    }

    /* Dark Mode Variables */
    body.dark {
      --bg: #0f172a;
      --sidebar: #1e293b;
      --surface: #1e293b;
      --text: #f3f4f6;
      --text-sec: #94a3b8;
      --border: #334155;
      --brand: #60a5fa;
      --brand-hover: #3b82f6;
      --brand-soft: #1e3a8a;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }

    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; margin: 0; font-family: var(--font-main); background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s; }

    /* Layout */
    .layout { display: flex; height: 100vh; overflow: hidden; }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--sidebar);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 20px;
      z-index: 50;
      transition: transform 0.3s ease, background 0.3s, border-color 0.3s;
    }
    .brand { font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 10px; margin-bottom: 30px; color: var(--text); }
    .brand-icon { width: 32px; height: 32px; background: var(--brand); border-radius: 8px; display: grid; place-items: center; color: white; }
    
    .nav-link {
      display: flex; align-items: center; gap: 12px; padding: 12px;
      color: var(--text-sec); text-decoration: none; border-radius: var(--radius);
      margin-bottom: 4px; font-weight: 500; transition: all 0.2s;
      background: transparent; border: none; width: 100%; text-align: left; cursor: pointer; font-family: inherit; font-size: 14px;
    }
    .nav-link:hover { background: var(--bg); color: var(--brand); }
    .nav-link.active { background: var(--brand-soft); color: var(--brand); }
    .nav-sep { margin: 20px 0 10px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sec); font-weight: 600; padding-left: 12px; }

    /* Footer do Sidebar para o Botão de Tema */
    .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border); }

    /* Main Content */
    .main { flex: 1; overflow-y: auto; padding: 24px; position: relative; }
    
    /* Header */
    .header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 16px; margin-bottom: 24px; }
    .page-title h1 { margin: 0; font-size: 24px; font-weight: 700; }
    .page-title p { margin: 4px 0 0; color: var(--text-sec); font-size: 14px; }

    /* Actions Bar */
    .actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .btn {
      display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px;
      border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer;
      border: 1px solid var(--border); background: var(--surface); color: var(--text);
      transition: all 0.2s; box-shadow: var(--shadow);
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn.primary { background: var(--brand); color: white; border-color: var(--brand); }
    .btn.primary:hover { background: var(--brand-hover); }
    .btn.danger { color: var(--bad); border-color: #fca5a5; background: #fef2f2; }
    body.dark .btn.danger { background: #450a0a; border-color: #7f1d1d; }

    /* Progress Bar */
    .progress-container {
      height: 4px; background: var(--border); width: 100%; border-radius: 2px; overflow: hidden; margin-top: 10px; display: none;
    }
    .progress-bar { height: 100%; background: var(--brand); width: 0%; transition: width 0.2s; }

    /* Filters */
    .filter-bar {
      background: var(--surface); border: 1px solid var(--border); padding: 16px;
      border-radius: var(--radius); margin-bottom: 24px; box-shadow: var(--shadow);
      display: flex; flex-wrap: wrap; gap: 16px; align-items: center; transition: background 0.3s, border-color 0.3s;
    }
    .input-group { display: flex; align-items: center; gap: 8px; }
    .input-group label { font-size: 13px; font-weight: 500; color: var(--text-sec); }
    input[type="date"], input[type="text"] {
      padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px;
      background: var(--bg); color: var(--text); font-family: inherit;
    }
    .quick-filters button {
      padding: 6px 12px; font-size: 12px; border-radius: 20px; border: 1px solid var(--border);
      background: transparent; color: var(--text-sec); cursor: pointer; margin-right: 4px;
    }
    .quick-filters button.active { background: var(--brand); color: white; border-color: var(--brand); }

    /* Range Info Display */
    .range-info {
      margin-left: auto; font-size: 13px; color: var(--text-sec);
      display: flex; align-items: center; gap: 8px;
      background: var(--bg); padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border);
    }

    /* Dashboard Grid */
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; }
    .card {
      background: var(--surface); border-radius: var(--radius); padding: 20px;
      border: 1px solid var(--border); box-shadow: var(--shadow);
      display: flex; flex-direction: column; transition: background 0.3s, border-color 0.3s;
    }
    
    .col-3 { grid-column: span 3; } .col-4 { grid-column: span 4; }
    .col-6 { grid-column: span 6; } .col-8 { grid-column: span 8; } .col-12 { grid-column: span 12; }
    
    @media (max-width: 1024px) { .col-3 { grid-column: span 6; } .col-4 { grid-column: span 6; } .col-8 { grid-column: span 12; } }
    @media (max-width: 768px) { .col-3, .col-4, .col-6, .col-8 { grid-column: span 12; } }

    /* KPI Styles */
    .kpi-title { color: var(--text-sec); font-size: 13px; font-weight: 600; text-transform: uppercase; margin-bottom: 8px; }
    .kpi-value { font-size: 28px; font-weight: 800; color: var(--text); }
    .kpi-sub { font-size: 13px; color: var(--text-sec); margin-top: 4px; display: flex; align-items: center; gap: 4px; }
    .trend-up { color: var(--good); } .trend-down { color: var(--bad); }

    /* Chips/Tags */
    .chips-container { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip {
      display: flex; align-items: center; gap: 6px; padding: 6px 12px;
      background: var(--bg); border: 1px solid var(--border); border-radius: 20px;
      font-size: 12px; cursor: pointer; user-select: none; transition: all 0.2s;
    }
    .chip:hover { border-color: var(--brand); }
    .chip.active { background: var(--brand-soft); border-color: var(--brand); color: var(--brand); font-weight: 600; }
    .chip input { display: none; }

    /* Tables */
    .table-container { overflow-x: auto; max-height: 600px; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th { text-align: left; padding: 12px 16px; background: var(--bg); color: var(--text-sec); font-weight: 600; position: sticky; top: 0; z-index: 10; }
    td { padding: 12px 16px; border-bottom: 1px solid var(--border); color: var(--text); }
    tr:hover td { background: var(--bg); }
    
    .status-pill { padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .status-lost { background: #fee2e2; color: #b91c1c; }
    .status-user { background: #dcfce7; color: #15803d; }
    .status-admin { background: #e0f2fe; color: #0369a1; }
    body.dark .status-lost { background: #7f1d1d; color: #fca5a5; }
    body.dark .status-user { background: #14532d; color: #86efac; }
    body.dark .status-admin { background: #0c4a6e; color: #7dd3fc; }

    /* Drag & Drop Overlay */
    #dropOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(59, 130, 246, 0.9); z-index: 1000;
      display: none; justify-content: center; align-items: center; flex-direction: column;
      color: white; font-weight: 700; font-size: 24px; backdrop-filter: blur(4px);
    }
    #dropOverlay.active { display: flex; }

    /* Mobile Menu */
    .mobile-toggle { display: none; background: none; border: none; font-size: 24px; color: var(--text); cursor: pointer; padding: 0; margin-right: 10px; }
    @media (max-width: 768px) {
      .sidebar { position: fixed; left: -260px; height: 100%; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
      .sidebar.open { transform: translateX(260px); }
      .mobile-toggle { display: block; }
      .filter-bar { flex-direction: column; align-items: stretch; }
      .quick-filters { overflow-x: auto; white-space: nowrap; padding-bottom: 4px; }
      .range-info { margin-left: 0; margin-top: 10px; }
    }

    /* Tabs for Reports */
    .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
    .tab-btn {
      padding: 10px 16px; background: none; border: none; border-bottom: 2px solid transparent;
      color: var(--text-sec); font-weight: 600; cursor: pointer;
    }
    .tab-btn.active { color: var(--brand); border-bottom-color: var(--brand); }

    @media print {
      .sidebar, .actions, .filter-bar, .theme-toggle { display: none !important; }
      .main { padding: 0; overflow: visible; }
      .card { box-shadow: none; border: 1px solid #ccc; break-inside: avoid; }
      body { background: white; color: black; }
    }
  </style>
</head>
<body>

<!-- Drag & Drop Overlay -->
<div id="dropOverlay">
  <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
  <div style="margin-top:16px">Solte os arquivos PDF aqui</div>
</div>

<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="brand-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
      </div>
      IXC Analytics
    </div>
    
    <nav>
      <button class="nav-link active" data-page="dashboard">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
        Dashboard
      </button>
      <button class="nav-link" data-page="tabela">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
        Tabela Detalhada
      </button>
      <button class="nav-link" data-page="ips">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
        Análise de IPs
      </button>
      <button class="nav-link" data-page="relatorios">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
        Relatórios AI
      </button>
      
      <div class="nav-sep">Sistema</div>
      <button class="nav-link" data-page="log">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>
        Log de Processamento
      </button>
    </nav>

    <!-- Botão de Tema no Rodapé do Sidebar -->
    <div class="sidebar-footer">
      <button class="nav-link" id="btnTheme">
        <svg id="iconTheme" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        <span id="txtTheme">Modo Escuro</span>
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main">
    <div class="header">
      <div style="display:flex; align-items:center;">
        <button class="mobile-toggle" id="btnMenu">☰</button>
        <div class="page-title">
          <h1 id="pageTitle">Dashboard Geral</h1>
          <p id="pageSubtitle">Visão consolidada das desconexões importadas.</p>
        </div>
      </div>

      <div class="actions">
        <input type="file" id="fileInput" accept=".pdf" multiple style="display:none">
        <button class="btn" onclick="document.getElementById('fileInput').click()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M17 8l-5-5-5 5M12 3v12"/></svg>
          Carregar PDF
        </button>
        <button class="btn primary" id="btnExport">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/></svg>
          CSV
        </button>
        <button class="btn danger" id="btnClear">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        </button>
      </div>
    </div>

    <div class="progress-container" id="progressContainer">
      <div class="progress-bar" id="progressBar"></div>
    </div>

    <!-- Filtros Globais -->
    <div class="filter-bar">
      <div class="input-group">
        <label>Filtrar Visualização:</label>
        <input type="date" id="dateStart">
        <span style="color:var(--text-sec)">a</span>
        <input type="date" id="dateEnd">
      </div>
      
      <div class="quick-filters">
        <button data-days="7">7d</button>
        <button data-days="15">15d</button>
        <button data-days="30">30d</button>
        <button id="btnResetDate">Todos</button>
      </div>

      <!-- Novo indicador de Período do Arquivo (Substitui a busca) -->
      <div class="range-info">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
        Período nos arquivos:
        <strong id="lblFileRange" style="color:var(--text)">—</strong>
      </div>
    </div>

    <!-- Conteúdo das Páginas -->
    <div id="contentArea">
      <!-- Injetado via JS -->
    </div>

  </main>
</div>

<!-- TEMPLATES -->

<!-- 1. DASHBOARD -->
<template id="tpl-dashboard">
  <div class="grid">
    <!-- KPIs -->
    <div class="card col-3">
      <div class="kpi-title">Total de Quedas</div>
      <div class="kpi-value" id="kpiTotal">0</div>
      <div class="kpi-sub">registros processados</div>
    </div>
    <div class="card col-3">
      <div class="kpi-title">Média Diária</div>
      <div class="kpi-value" id="kpiAvg">0</div>
      <div class="kpi-sub" id="kpiAvgLabel">nos dias selecionados</div>
    </div>
    <div class="card col-3">
      <div class="kpi-title">IPs Únicos</div>
      <div class="kpi-value" id="kpiUniqueIps">0</div>
      <div class="kpi-sub">afetados no período</div>
    </div>
    <div class="card col-3">
      <div class="kpi-title">Arquivos</div>
      <div class="kpi-value" id="kpiFiles">0</div>
      <div class="kpi-sub" id="kpiPages">0 páginas lidas</div>
    </div>

    <!-- Seletor de Motivos -->
    <div class="card col-12">
      <div style="font-weight:600; margin-bottom:10px;">Filtrar Motivos</div>
      <div class="chips-container" id="reasonsContainer"></div>
    </div>

    <!-- Gráficos -->
    <div class="card col-8" style="min-height: 350px;">
      <canvas id="chartHistory"></canvas>
    </div>
    <div class="card col-4" style="min-height: 350px;">
      <canvas id="chartReason"></canvas>
    </div>
  </div>
</template>

<!-- 2. TABELA -->
<template id="tpl-tabela">
  <div class="card col-12">
    <div class="table-container">
      <table id="mainTable">
        <thead>
          <tr>
            <th>Data/Hora</th>
            <th>Login</th>
            <th>Motivo</th>
            <th>IP</th>
            <th>Detalhe (Raw)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="margin-top:10px; text-align:center; color:var(--text-sec); font-size:12px;">Mostrando até 1000 registros mais recentes para performance. Use CSV para ver tudo.</div>
  </div>
</template>

<!-- 3. IPs -->
<template id="tpl-ips">
  <div class="grid">
    <div class="card col-12">
      <div class="table-container">
        <table id="ipTable">
          <thead>
            <tr>
              <th>Endereço IP</th>
              <th>Total de Quedas</th>
              <th>Primeira Ocorrência</th>
              <th>Última Ocorrência</th>
              <th>Motivo Principal</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</template>

<!-- 4. RELATORIOS -->
<template id="tpl-relatorios">
  <div class="card col-12">
    <div class="tabs">
      <button class="tab-btn active" onclick="app.renderReport('overview')">Resumo 15 Dias</button>
      <button class="tab-btn" onclick="app.renderReport('picos')">Análise de Picos</button>
    </div>
    <div id="reportContent" style="padding: 10px 0;"></div>
  </div>
</template>

<!-- 5. LOG -->
<template id="tpl-log">
  <div class="card col-12">
    <div style="background: var(--bg); padding: 16px; border-radius: 8px; font-family: monospace; font-size: 13px; height: 400px; overflow-y: auto;" id="logBox">
      Aguardando processamento...
    </div>
  </div>
</template>

<script>
/**
 * IXC Analytics Dashboard Logic
 * v2.2 - Auto Dark Mode & UI Fixes
 */
const app = (function() {
  // State
  const state = {
    files: [],
    rawData: [],     // { date, login, reason, ip, rawLine }
    filteredData: [],
    reasonsStats: {},
    dateRange: { min: null, max: null },
    filters: {
      start: null,
      end: null,
      excludedReasons: new Set()
    },
    ui: {
      activePage: 'dashboard',
      theme: 'light' // Initial default, overwritten in init
    }
  };

  // Config
  const CONFIG = {
    reasons: {
      "Lost-Carrier": "loss", "User-Request": "user", "Admin-Reset": "admin",
      "Session-Timeout": "warn", "Nas-Error": "bad", "Idle-Timeout": "warn"
    }
  };

  // DOM Elements cache
  const els = {};

  function init() {
    // Cache Elements
    ['fileInput', 'btnExport', 'btnClear', 'btnResetDate', 'dateStart', 'dateEnd', 
     'contentArea', 'pageTitle', 'pageSubtitle', 'progressContainer', 
     'progressBar', 'logBox', 'sidebar', 'btnMenu', 'btnTheme', 'lblFileRange', 
     'iconTheme', 'txtTheme'].forEach(id => els[id] = document.getElementById(id));

    // Event Listeners
    els.fileInput.addEventListener('change', handleFileSelect);
    els.btnClear.addEventListener('click', clearAll);
    els.btnExport.addEventListener('click', exportCSV);
    els.btnResetDate.addEventListener('click', () => setQuickDate(null));
    els.dateStart.addEventListener('change', updateFilters);
    els.dateEnd.addEventListener('change', updateFilters);
    els.btnMenu.addEventListener('click', () => els.sidebar.classList.toggle('open'));
    els.btnTheme.addEventListener('click', toggleTheme);

    document.querySelectorAll('.quick-filters button[data-days]').forEach(btn => {
      btn.addEventListener('click', (e) => setQuickDate(parseInt(e.target.dataset.days)));
    });

    // Navigation (using buttons instead of A tags for cleaner app-like feel)
    document.querySelectorAll('.nav-link[data-page]').forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        navigateTo(e.currentTarget.dataset.page);
        if(window.innerWidth <= 768) els.sidebar.classList.remove('open');
      });
    });

    // Drag & Drop
    const dropZone = document.body;
    const overlay = document.getElementById('dropOverlay');
    
    ['dragenter', 'dragover'].forEach(evt => {
      dropZone.addEventListener(evt, (e) => { e.preventDefault(); overlay.classList.add('active'); });
    });
    ['dragleave', 'drop'].forEach(evt => {
      dropZone.addEventListener(evt, (e) => { e.preventDefault(); overlay.classList.remove('active'); });
    });
    dropZone.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      if(files.length) handleFiles(files);
    });

    // --- Theme Initialization Logic ---
    initTheme();

    // Initial Render
    navigateTo('dashboard');
  }

  // --- Theme Logic ---
  
  function initTheme() {
    // 1. Check LocalStorage
    const storedTheme = localStorage.getItem('ixc_theme');
    
    if (storedTheme) {
      applyTheme(storedTheme);
    } else {
      // 2. Check System Preference
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      applyTheme(prefersDark ? 'dark' : 'light');
    }

    // Listen for system changes only if user hasn't overridden
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (!localStorage.getItem('ixc_theme')) {
        applyTheme(event.matches ? 'dark' : 'light');
      }
    });
  }

  function toggleTheme() {
    const isDark = document.body.classList.contains('dark');
    const newTheme = isDark ? 'light' : 'dark';
    applyTheme(newTheme);
    // Persist user choice
    localStorage.setItem('ixc_theme', newTheme);
  }

  function applyTheme(theme) {
    state.ui.theme = theme;
    
    if (theme === 'dark') {
      document.body.classList.add('dark');
      // Update Button UI
      els.txtTheme.innerText = 'Modo Claro';
      els.iconTheme.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
    } else {
      document.body.classList.remove('dark');
      // Update Button UI
      els.txtTheme.innerText = 'Modo Escuro';
      els.iconTheme.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
    }
  }

  // --- Core Processing Logic ---

  async function handleFileSelect(e) {
    handleFiles(e.target.files);
  }

  async function handleFiles(fileList) {
    const files = Array.from(fileList).filter(f => f.name.toLowerCase().endsWith('.pdf'));
    if (!files.length) return alert('Selecione arquivos PDF válidos.');

    els.progressContainer.style.display = 'block';
    updateProgress(0);
    log(`Iniciando processamento de ${files.length} arquivos...`);

    let totalPages = 0;
    // Pre-scan to get total pages for accurate progress bar
    for (const file of files) {
       try {
         const pdf = await pdfjsLib.getDocument(await file.arrayBuffer()).promise;
         totalPages += pdf.numPages;
       } catch(e) { console.error(e); }
    }

    let processedPages = 0;
    let newRows = [];

    for (const file of files) {
      try {
        log(`Lendo: ${file.name}`);
        const buffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(buffer).promise;
        
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          
          // Convert visual items to lines based on Y coordinate
          const lines = itemsToTextLines(textContent.items);
          const parsed = parseLines(lines);
          newRows = newRows.concat(parsed);
          
          processedPages++;
          updateProgress((processedPages / totalPages) * 100);
          
          // Yield to UI thread to prevent freeze
          if (i % 5 === 0) await new Promise(r => setTimeout(r, 0));
        }
        state.files.push(file.name);
      } catch (err) {
        log(`ERRO em ${file.name}: ${err.message}`);
      }
    }

    state.rawData = removeDuplicates([...state.rawData, ...newRows]);
    state.rawData.sort((a,b) => b.date - a.date); // Sort descending
    
    // Determine default date range
    if(state.rawData.length) {
       const dates = state.rawData.map(r => r.date);
       state.dateRange.min = new Date(Math.min(...dates));
       state.dateRange.max = new Date(Math.max(...dates));
       
       updateFileRangeDisplay();

       // Default filter: last 15 days if available
       setQuickDate(15, false);
    }

    updateProgress(100);
    setTimeout(() => { els.progressContainer.style.display = 'none'; }, 1000);
    log(`Processamento concluído. ${newRows.length} novas linhas.`);
    
    updateFilters();
  }

  function itemsToTextLines(items) {
    const rows = {};
    items.forEach(item => {
      const y = Math.round(item.transform[5]); // Y coordinate
      if (!rows[y]) rows[y] = [];
      rows[y].push(item.str);
    });
    // Sort by Y descending (top to bottom)
    return Object.keys(rows).sort((a,b) => b-a).map(y => rows[y].join(" "));
  }

  function parseLines(lines) {
    const results = [];
    const reasonsKeywords = [
      "Lost-Carrier", "User-Request", "Admin-Reset", "Session-Timeout", 
      "Nas-Error", "Idle-Timeout", "Port-Error", "Service-Unavailable", 
      "Accounting-Stop", "Admin-Reboot", "Host-Request"
    ];
    const reasonRegex = new RegExp(`\\b(${reasonsKeywords.join("|")})\\b`, "i");
    const dateRegex = /(\d{2}\/\d{2}\/\d{4})\s+(\d{2}:\d{2}:\d{2})/;
    const ipRegex = /(?:\d{1,3}\.){3}\d{1,3}/;

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      const reasonMatch = line.match(reasonRegex);

      if (reasonMatch) {
        const context = [lines[i-2]||"", lines[i-1]||"", line].join(" ");
        const dateMatch = context.match(dateRegex);
        if (!dateMatch) continue;

        const dateObj = parseDatePTBR(dateMatch[1], dateMatch[2]);
        const reason = reasonMatch[1];
        
        const ipMatch = context.match(ipRegex);
        const ip = ipMatch ? ipMatch[0] : "";

        let login = "Desconhecido";
        const parts = line.split(reason)[0].trim().split(/\s+/);
        const candidate = parts[parts.length - 1];
        if (candidate && candidate.length > 3 && !candidate.includes("/")) {
          login = candidate;
        }

        results.push({
          id: dateObj.getTime() + reason + ip,
          date: dateObj,
          reason: reason,
          ip: ip,
          login: login,
          rawLine: line
        });
      }
    }
    return results;
  }

  function parseDatePTBR(dateStr, timeStr) {
    const [d, m, y] = dateStr.split('/').map(Number);
    const [hr, min, sec] = timeStr.split(':').map(Number);
    return new Date(y, m - 1, d, hr, min, sec);
  }

  function removeDuplicates(arr) {
    const seen = new Set();
    return arr.filter(item => {
      const key = item.id;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });
  }

  // --- Filtering & UI Update ---

  function updateFilters() {
    let start = els.dateStart.value ? new Date(els.dateStart.value + "T00:00:00") : null;
    let end = els.dateEnd.value ? new Date(els.dateEnd.value + "T23:59:59") : null;
    
    state.filters.start = start;
    state.filters.end = end;
    
    state.filteredData = state.rawData.filter(row => {
      if (start && row.date < start) return false;
      if (end && row.date > end) return false;
      if (state.filters.excludedReasons.has(row.reason)) return false;
      return true;
    });

    renderCurrentPage();
  }

  function updateFileRangeDisplay() {
    const min = state.dateRange.min;
    const max = state.dateRange.max;
    if (min && max) {
      els.lblFileRange.innerText = `${min.toLocaleDateString('pt-BR')} até ${max.toLocaleDateString('pt-BR')}`;
    } else {
      els.lblFileRange.innerText = "—";
    }
  }

  function setQuickDate(days, triggerUpdate = true) {
    document.querySelectorAll('.quick-filters button').forEach(b => b.classList.remove('active'));
    
    if (days === null) {
      els.dateStart.value = '';
      els.dateEnd.value = '';
      els.btnResetDate.classList.add('active');
    } else {
      const end = new Date();
      const refDate = state.dateRange.max || new Date();
      
      const start = new Date(refDate);
      start.setDate(refDate.getDate() - (days - 1));
      
      els.dateStart.value = start.toISOString().split('T')[0];
      els.dateEnd.value = refDate.toISOString().split('T')[0];
      
      const btn = document.querySelector(`.quick-filters button[data-days="${days}"]`);
      if(btn) btn.classList.add('active');
    }
    if (triggerUpdate) updateFilters();
  }

  function navigateTo(pageId) {
    state.ui.activePage = pageId;
    
    document.querySelectorAll('.nav-link[data-page]').forEach(l => l.classList.remove('active'));
    document.querySelector(`.nav-link[data-page="${pageId}"]`).classList.add('active');

    const titles = {
      dashboard: "Dashboard Geral",
      tabela: "Tabela Detalhada",
      ips: "Análise de IPs",
      relatorios: "Relatórios Inteligentes",
      log: "Log do Sistema"
    };
    els.pageTitle.innerText = titles[pageId];

    const tpl = document.getElementById(`tpl-${pageId}`);
    els.contentArea.innerHTML = '';
    els.contentArea.appendChild(tpl.content.cloneNode(true));

    renderCurrentPage();
  }

  function renderCurrentPage() {
    const page = state.ui.activePage;
    if (page === 'dashboard') renderDashboard();
    else if (page === 'tabela') renderTable();
    else if (page === 'ips') renderIps();
    else if (page === 'relatorios') renderReport('overview');
    else if (page === 'log') { /* Log is static/global */ }
  }

  // --- Renderers ---

  let charts = {};

  function renderDashboard() {
    const total = state.filteredData.length;
    const distinctIps = new Set(state.filteredData.map(r => r.ip)).size;
    
    let days = 1;
    if (state.filteredData.length > 0) {
      const times = state.filteredData.map(r => r.date.getTime());
      const min = Math.min(...times);
      const max = Math.max(...times);
      days = Math.max(1, Math.ceil((max - min) / (1000 * 60 * 60 * 24)));
    }
    const avg = total / days;

    document.getElementById('kpiTotal').innerText = total.toLocaleString();
    document.getElementById('kpiAvg').innerText = avg.toFixed(1);
    document.getElementById('kpiUniqueIps').innerText = distinctIps.toLocaleString();
    document.getElementById('kpiFiles').innerText = state.files.length;
    document.getElementById('kpiPages').innerText = `${Math.ceil(total/50)} pgs est.`;

    const reasonsCount = {};
    state.rawData.forEach(r => reasonsCount[r.reason] = (reasonsCount[r.reason]||0) + 1);
    
    const container = document.getElementById('reasonsContainer');
    if (container) {
      container.innerHTML = '';
      Object.keys(reasonsCount).sort((a,b) => reasonsCount[b] - reasonsCount[a]).forEach(r => {
        const isActive = !state.filters.excludedReasons.has(r);
        const el = document.createElement('div');
        el.className = `chip ${isActive ? 'active' : ''}`;
        el.innerText = `${r} (${reasonsCount[r]})`;
        el.onclick = () => {
          if (isActive) state.filters.excludedReasons.add(r);
          else state.filters.excludedReasons.delete(r);
          updateFilters();
        };
        container.appendChild(el);
      });
    }

    const reasonsMap = {};
    const datesMap = {};
    
    state.filteredData.forEach(r => {
      reasonsMap[r.reason] = (reasonsMap[r.reason] || 0) + 1;
      const dKey = r.date.toISOString().split('T')[0];
      datesMap[dKey] = (datesMap[dKey] || 0) + 1;
    });

    if(charts.history) charts.history.destroy();
    if(charts.reason) charts.reason.destroy();

    const sortedDates = Object.keys(datesMap).sort();
    
    // Theme colors for charts
    const gridColor = state.ui.theme === 'dark' ? '#334155' : '#e5e7eb';
    const textColor = state.ui.theme === 'dark' ? '#94a3b8' : '#6b7280';

    charts.history = new Chart(document.getElementById('chartHistory'), {
      type: 'line',
      data: {
        labels: sortedDates.map(d => d.split('-').reverse().join('/')),
        datasets: [{
          label: 'Quedas por Dia',
          data: sortedDates.map(d => datesMap[d]),
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          fill: true,
          tension: 0.3
        }]
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false, 
        scales: {
          x: { grid: { color: gridColor }, ticks: { color: textColor } },
          y: { grid: { color: gridColor }, ticks: { color: textColor } }
        },
        plugins: { 
          legend: {display:false}, 
          title: {display:true, text: 'Evolução Diária', color: textColor} 
        } 
      }
    });

    const sortedReasons = Object.keys(reasonsMap).sort((a,b) => reasonsMap[b] - reasonsMap[a]);
    charts.reason = new Chart(document.getElementById('chartReason'), {
      type: 'doughnut',
      data: {
        labels: sortedReasons,
        datasets: [{
          data: sortedReasons.map(r => reasonsMap[r]),
          backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#8b5cf6'],
          borderColor: state.ui.theme === 'dark' ? '#1e293b' : '#ffffff'
        }]
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false, 
        plugins: { 
          legend: {position:'bottom', labels: { color: textColor }}, 
          title: {display:true, text: 'Principais Motivos', color: textColor} 
        } 
      }
    });
  }

  function renderTable() {
    const tbody = document.querySelector('#mainTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    
    const viewData = state.filteredData.slice(0, 1000);
    
    viewData.forEach(r => {
      let pillClass = 'status-admin';
      if(r.reason.toLowerCase().includes('lost')) pillClass = 'status-lost';
      else if(r.reason.toLowerCase().includes('user')) pillClass = 'status-user';
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.date.toLocaleString('pt-BR')}</td>
        <td><strong>${r.login}</strong></td>
        <td><span class="status-pill ${pillClass}">${r.reason}</span></td>
        <td>${r.ip}</td>
        <td style="color:var(--text-sec); font-size:12px; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${r.rawLine}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderIps() {
    const tbody = document.querySelector('#ipTable tbody');
    if (!tbody) return;
    
    const ipStats = {};
    state.filteredData.forEach(r => {
      if(!r.ip) return;
      if(!ipStats[r.ip]) ipStats[r.ip] = { count: 0, first: r.date, last: r.date, reasons: {} };
      const s = ipStats[r.ip];
      s.count++;
      if(r.date < s.first) s.first = r.date;
      if(r.date > s.last) s.last = r.date;
      s.reasons[r.reason] = (s.reasons[r.reason]||0) + 1;
    });

    const sortedIps = Object.entries(ipStats).sort((a,b) => b[1].count - a[1].count).slice(0, 500); // Top 500
    
    tbody.innerHTML = '';
    sortedIps.forEach(([ip, s]) => {
      const topReason = Object.entries(s.reasons).sort((a,b) => b[1] - a[1])[0][0];
      
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td style="font-family:monospace">${ip}</td>
        <td>${s.count}</td>
        <td>${s.first.toLocaleString('pt-BR')}</td>
        <td>${s.last.toLocaleString('pt-BR')}</td>
        <td>${topReason}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderReport(type) {
    const container = document.getElementById('reportContent');
    if (!container) return;
    
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    
    if (type === 'overview') {
      const topLogin = getTopMetric(state.filteredData, 'login');
      const topReason = getTopMetric(state.filteredData, 'reason');
      
      container.innerHTML = `
        <div style="padding:10px">
          <h3>Resumo do Período Filtrado</h3>
          <p>Análise baseada em <b>${state.filteredData.length}</b> eventos.</p>
          <ul style="line-height: 1.8;">
            <li>O motivo mais frequente é <b>${topReason.key}</b> com ${topReason.value} ocorrências (${((topReason.value/state.filteredData.length)*100).toFixed(1)}%).</li>
            <li>O cliente/login mais afetado foi <b>${topLogin.key}</b> com ${topLogin.value} quedas.</li>
          </ul>
        </div>
      `;
    } else if (type === 'picos') {
      const daily = {};
      state.filteredData.forEach(r => {
        const d = r.date.toISOString().split('T')[0];
        daily[d] = (daily[d]||0) + 1;
      });
      const vals = Object.values(daily);
      const mean = vals.reduce((a,b)=>a+b,0) / vals.length || 0;
      
      const suspiciousDays = Object.entries(daily).filter(([d, count]) => count > mean * 1.5);
      
      let html = `<div style="padding:10px"><h3>Dias com Anomalias (>50% da média)</h3>`;
      if(suspiciousDays.length === 0) html += `<p style="color:var(--good)">Nenhuma anomalia detectada. O comportamento está estável.</p>`;
      else {
        html += `<ul>`;
        suspiciousDays.forEach(([d, c]) => {
          html += `<li><b>${d.split('-').reverse().join('/')}</b>: ${c} quedas (Média: ${mean.toFixed(0)})</li>`;
        });
        html += `</ul>`;
      }
      html += `</div>`;
      container.innerHTML = html;
    }
  }

  function getTopMetric(data, key) {
    const map = {};
    data.forEach(r => map[r[key]] = (map[r[key]]||0)+1);
    const sorted = Object.entries(map).sort((a,b) => b[1]-a[1]);
    return sorted.length ? {key: sorted[0][0], value: sorted[0][1]} : {key:'-', value:0};
  }

  function log(msg) {
    const box = document.getElementById('logBox');
    if(box) {
      const time = new Date().toLocaleTimeString();
      box.innerHTML += `<div>[${time}] ${msg}</div>`;
      box.scrollTop = box.scrollHeight;
    }
    console.log(msg);
  }

  function updateProgress(percent) {
    const bar = document.getElementById('progressBar');
    if(bar) bar.style.width = `${percent}%`;
  }

  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  function clearAll() {
    state.files = [];
    state.rawData = [];
    state.filteredData = [];
    state.dateRange = { min: null, max: null };
    els.fileInput.value = '';
    
    // Fix: Check if element exists before accessing innerHTML
    const container = document.getElementById('reasonsContainer');
    if (container) container.innerHTML = '';
    
    updateFileRangeDisplay();
    updateFilters();
    log("Dados limpos.");
  }

  function exportCSV() {
    if(!state.filteredData.length) return alert("Sem dados para exportar.");
    
    let csvContent = "data:text/csv;charset=utf-8,";
    csvContent += "Data/Hora,Login,Motivo,IP,Linha Original\n";
    
    state.filteredData.forEach(r => {
      const row = [
        r.date.toLocaleString('pt-BR'),
        r.login,
        r.reason,
        r.ip,
        `"${r.rawLine.replace(/"/g, '""')}"`
      ];
      csvContent += row.join(",") + "\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "ixc_relatorio_quedas.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  return { init, renderReport };
})();

// Start
document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
